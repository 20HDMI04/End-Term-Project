generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                   String   @id
  email                String   @unique
  username             String
  nickname             String?
  smallerProfilePic    String?
  biggerProfilePic     String?
  smallerProfilePicKey String?
  biggerProfilePicKey  String?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @default(now()) @updatedAt()

  ratings         Rating[]
  comments        Comment[]
  haveReadIt      HaveReadIt[]
  favoriteBooks   FavoriteBook[]
  favoriteAuthors FavoriteAuthor[]
  favoriteGenres  FavoriteGenre[]
  commentVotes    CommentLike[]
}

model Author {
  id   String @id @default(uuid())
  name String

  openLibraryId String? @unique

  smallerProfilePic    String?
  biggerProfilePic     String?
  smallerProfilePicKey String?
  biggerProfilePicKey  String?
  topWorks             String?
  subjects             String?
  bio                  String?   @db.Text
  birthDate            DateTime?
  nationality          String?
  approveStatus        Boolean   @default(false)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  books       Book[]
  favoritedBy FavoriteAuthor[]

  @@index([name])
}

model Book {
  id       String  @id @default(uuid())
  title    String
  authorId String?

  googleBookId  String? @unique
  openLibraryId String? @unique

  smallerCoverPic    String
  biggerCoverPic     String
  smallerCoverPicKey String?
  biggerCoverPicKey  String?

  originalPublisher       String?
  originalPublicationYear Int?
  latestPublicationYear   Int?

  pageNumber  Int?
  description String   @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  approveStatus Boolean @default(false)

  author      Author?         @relation(fields: [authorId], references: [id], onDelete: Restrict, onUpdate: Cascade)
  isbns       BookIsbn[]
  statistics  BookStatistics?
  genres      BookGenres[]
  haveReadIt  HaveReadIt[]
  favoritedBy FavoriteBook[]
  ratings     Rating[]
  comments    Comment[]

  @@unique([title, authorId])
}

model BookIsbn {
  id         String @id @default(uuid())
  isbnNumber String @unique
  bookId     String
  book       Book   @relation(fields: [bookId], references: [id], onDelete: Cascade)
}

model Genres {
  id          String          @id @default(uuid())
  name        String          @unique
  books       BookGenres[]
  favoritedBy FavoriteGenre[]
}

model BookGenres {
  bookId  String
  genreId String
  book    Book   @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  genre   Genres @relation(fields: [genreId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([bookId, genreId])
}

model FavoriteGenre {
  userId  String
  genreId String
  user    User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  genre   Genres @relation(fields: [genreId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, genreId])
}

model FavoriteBook {
  userId String
  bookId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  book   Book   @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, bookId])
}

model FavoriteAuthor {
  userId   String
  authorId String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  author   Author @relation(fields: [authorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, authorId])
}

model Rating {
  userId    String
  bookId    String
  score     Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  book      Book     @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, bookId])
}

model Comment {
  id        String        @id @default(cuid())
  text      String
  createdAt DateTime      @default(now())
  userId    String
  bookId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  book      Book          @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  votes     CommentLike[]
}

model CommentLike {
  userId    String
  commentId String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  comment   Comment @relation(fields: [commentId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  @@id([userId, commentId])
}

model BookStatistics {
  id              String @id @default(uuid())
  bookId          String @unique
  averageRating   Float  @default(0.0)
  ratingCount     Int    @default(0)
  readersCount    Int    @default(0)
  wantToReadCount Int    @default(0)
  reviewCount     Int    @default(0)

  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model HaveReadIt {
  id      String   @id @default(uuid())
  userId  String
  bookId  String
  addedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  book Book @relation(fields: [bookId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}
